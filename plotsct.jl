using PlotlyJS, ColorSchemes

""" Define styles """

OwlBlue() = "#0098E9"
OwlRed() = "#FF5CA8"
OwlYellow() = "#F29318"
OwlOrange() = "#F97860"
OwlGreen() = "#5AA800"
OwlPurple() = "#807AC9"

defblue() = "#1f77b4"

Owls() = [OwlBlue(), OwlOrange(), OwlGreen(), OwlPurple(), OwlYellow(), OwlRed()]
Owls(k::Int64) = cycle(k - 1, Owls())

BlRd() = [
    "#001621",
    "#004164",
    "#006DA6",
    "#0098E9",
    "#3FB1ED",
    "#7DC9F2",
    "#BCE2F6",
    "#F4CEC3",
    "#EB8B71",
    "#E2481E"
]
BlRd(k::Int64) = cycle(k, BlRd())

cycle(k::Int64, v::Vector) = v[k%length(v)+1]

sand() = "#F5F3F1"
darkbgd() = "#272929"
lightgrid() = "#353535"
darkgrid() = "#e2e2e2"
gridcol(dark=false) = ifelse(dark, lightgrid(), darkgrid())

q_axis(dark) = attr(showgrid=true, gridcolor=gridcol(dark), gridwidth=0.5, zeroline=false)
bgcol(slides, dark) = ifelse(slides, ifelse(dark, darkbgd(), sand()), "white")
qleg() = attr(orientation="h", x=0.05, xanchor="left")

qwidth(slides) = 864
qheight(slides) = ceil(Int, qwidth(slides) * ifelse(slides, 10 / 16, 7 / 16))

function qtemplate(; dark=false, slides=!dark)
	axis = q_axis(dark)
	width = 864 #1920 * 0.45
	l = Layout(
		xaxis=axis, yaxis=axis,
		width=width,
		height=width * ifelse(slides, 10 / 16, 7 / 16),
		font=attr(
			family=ifelse(slides, "Lato", "Linux Libertine"),
			size=16, color=ifelse(dark, sand(), darkbgd())
		),
		paper_bgcolor=bgcol(slides, dark), plot_bgcolor=bgcol(slides, dark),
		legend=qleg(),
	)
	return Template(layout=l)
end


function plot_announcements(; slides = true, dark = false, add_opt=false, cond_t=false, cond=cond_t)
	xvec = 0:0.25:10

	slides ? colorpal = ColorSchemes.davos : colorpal = ColorSchemes.southwest
	slides ? correction = 0.8 : correction = 1
	dark ? fl = 0.2 : fl = 0
    
    colorpal = ColorSchemes.lapaz
    correction = 0.9

	line_opt = scatter(;x=xvec, y=((1.750133)-(0.784)) * exp.(-0.4951.*(4.0.*xvec)).+(0.784), showlegend=false, marker_color="#d62728", line_width=3, line_dash="dash")

	lines = [scatter(;x=xvec, y=(a0-œá) * exp.(-œâ.*(xvec)).+œá, showlegend=false, marker_color=get(colorpal, fl + correction*œá/2, :clamp)) for a0 in range(0,2, length=5) for œâ in range(0,0.8,length=3) for (jœá, œá) in enumerate(range(2,0,length=5)) if œâ != 0.0]

	plotname = "announcements"
	annotations = []
	if cond
		lines = [lines[43]]
		plotname *= "_cond"
		te = 9*4+1
		xe = lines[1][:x][te]
		ye = lines[1][:y][te]
		col_line = lines[1][:marker][:color]
		push!(annotations, attr(; x=xe, y=ye+0.05, text="<i>c", font_color=col_line, showarrow=false))
	end

	if add_opt
		push!(lines, line_opt)
		plotname *= "_w_opt"
	end

	dark ? shape_col = get(ColorSchemes.davos, 0.9, :clamp) : shape_col = get(ColorSchemes.darkrainbow, 0.12, :clamp)
	shapes = []
	if cond_t
		tt = 11
		x0 = lines[1][:x][tt]
		y0 = lines[1][:y][tt]
		shapes = [vline(x0, line_dash = "dash", line_color=shape_col); attr(;x0=x0-1*0.03, x1 = x0+1*0.03, y0 = y0-1*0.01, y1=y0+1*0.01, line_color=shape_col, fillcolor=shape_col, type="circle")]
		push!(annotations,attr(; x=x0 + 0.05, y=y0 + 0.01, text="<i>a<sub>t</sub><sup>c</sup>", ax=35, font_color = shape_col, font_size=24, font_family="Lato"))
		plotname *="_t"
	end

    layout = Layout(
        template = qtemplate(slides=slides, dark=dark),
        xaxis_title="<i>Quarters", yaxis_range=[-0.1;2.1], yaxis_title="%",
        title="Inflation announcements", shapes = shapes, 
        annotations=annotations,
        )

	plot(lines, layout)
end


function hplot(ct::CrazyType; share = false, kwargs...)
    y = [ct.gœÄ[jp, ja] - av for jp in eachindex(ct.gr[:p]), (ja, av) in enumerate(ct.gr[:a])]
    y = annualized.(y)

    title = "<i>g<sup>‚ãÜ</sup> - a"
    yaxis_title = "%"
    if share
        y *= 1/annualized(Nash(ct))
        yaxis_title = "Share of Nash inflation"
    end

    ctplot(ct, y; title, yaxis_title, kwargs...)
end


function Eplot(ct::CrazyType; kwargs...)
    y = [ct.Ep[jp, ja] .- pv for (jp, pv) in enumerate(ct.gr[:p]), ja in eachindex(ct.gr[:a])]

    ctplot(ct, y, title = "ùîº[<i>p'-p</i>]"; kwargs...)
end

Cplot(ct::CrazyType; kwargs...) = ctplot(ct, ct.C; kwargs...)
gplot(ct::CrazyType; kwargs...) = ctplot(ct, annualized.(ct.gœÄ); kwargs...)
Lplot(ct::CrazyType; kwargs...) = ctplot(ct, ct.L, title = "ùìõ"; kwargs...)
function ctplot(ct::CrazyType, y::Array; slides=true, dark=false, mod_a = 1, kwargs...)

    vv = [ja / length(ct.gr[:a]) for ja in eachindex(ct.gr[:a])]
    if dark
        col = get(ColorSchemes.lapaz, 1 .- 0.9 * vv, :clamp)
    else
        col = get(ColorSchemes.lapaz, 0.95 * vv, :clamp)
    end

    min_a, max_a = annualized.(extrema(ct.gr[:a])) ./ annualized.(Nash(ct))

    jp = round(Int, length(ct.gr[:p])/2)
	xs = [ct.gr[:p][jp] for _ in axes(y, 2)]
    ys = [y[jp, ja] for ja in axes(y, 2)]
    cols = range(0,1,length=length(xs))
	colscale = [[(jp-1)/(length(col)-1), col[jp]] for jp in eachindex(col)]
    colnames = round.(range(min_a, max_a, length=6), digits=2)

    data = [
        scatter(mode = "markers", marker_opacity = 0,
				x = xs, y = ys, showlegend=false,
				marker = attr(color=cols, reversescale=false, colorscale=colscale, colorbar = attr(tickvals=range(min_a, max_a,length=length(colnames)), title="&nbsp;<i>a/œÄ<sup>N", ticktext=colnames))
				)
        [scatter(x = ct.gr[:p], y = y[:, ja], line_width = 1.75, marker_color = col[ja], name = "a = $(round(annualized(av), sigdigits=2))") for (ja, av) in enumerate(ct.gr[:a]) if ja % mod_a == 0]
    ]

    template = qtemplate(dark = dark, slides = slides)

    layout = Layout(template = template, xaxis_title = "<i>p", hovermode ="x", showlegend=false; kwargs...)

    plot(data[end:-1:1], layout)
end

function astar(ct::CrazyType; dark = false, slides = true, kwargs...)

    avec = [annualized(ct.gr[:a][findmin(ct.L[jp,:])[2]]) for jp in eachindex(ct.gr[:p])]

    sc = scatter(x = ct.gr[:p], y = avec)

    template = qtemplate(; dark, slides)

    layout = Layout(; template, xaxis_title = "<i>p", yaxis_title = "<i>%", hovermode = "x", kwargs...)

    plot(sc, layout)
end



function Cplot(mt::MultiType; jp = 2, kwargs...)

    Nœâ, Nœá, Np, Na = size(mt.L_mat)
    C = zeros(Na, Nœá)
    for ja in axes(C, 1), jœá in axes(C, 2)
        _, jœâ = findmin(mt.L_mat[:, jœá, jp, ja])
        C[ja, jœá] = mt.C_mat[jœâ, jœá, jp, ja]
    end

    ctœâplot(mt, C, title="lim<sub><i>p‚Üí0</i></sub> C(<i>p,a,œâ*,œá</i>)"; kwargs...)
end

function Lplot_fixed_œâ(mt::MultiType; jp = 2, kwargs...)
    _, jj = findmin(mt.L_mat[:,:,2,:])

    jœá = jj[2]

    L = mt.L_mat[:, jœá, jp, :]
    title = "lim<sub><i>p‚Üí0</i></sub> ùìõ(<i>p,a,œâ,œá*</i>)"

    ctaplot(mt, L, title = title; kwargs...)
end
function Lplot(mt::MultiType; jp = 2, kwargs...)
    L = [minimum(mt.L_mat[jœâ, jœá, jp, :]) for jœâ in axes(mt.L_mat,1), jœá in axes(mt.L_mat, 2)]

    jj = findfirst(L .== minimum(L))
	xmin = perc_rate(mt.œâgrid[jj[1]])
	ymin = annualized(mt.œágrid[jj[2]])

    title = "lim<sub><i>p‚Üí0</i></sub> min<sub><i>a</i></sub> ùìõ(<i>p,a,œâ,œá</i>)"
    shape_vec = [attr(;x0=xmin-0.001, x1 = xmin+0.001, y0 = ymin-0.002, y1=ymin+0.002, line_color = "#08282e", fillcolor="#08282e", type = "circle")]

    ctplot(mt, L; title = title, shapes = shape_vec, kwargs...)
end

function Lœâplot(m0::Prequel; jp = 2, jA = 1, slides=true, dark=false, kwargs...)
    L = [minimum(m0.L[:, jœá, ja, jp, jA]) for ja in axes(m0.L, 3), jœá in axes(m0.L, 2)]

    jj = findfirst(L .== minimum(L))
    xmin = annualized(m0.agrid[jj[1]])
    ymin = annualized(m0.œágrid[jj[2]])

    shape_vec = [
        attr(; x0=xmin - 0.001, x1=xmin + 0.001, y0=ymin - 0.002, y1=ymin + 0.002, line_color="darkred", fillcolor="darkred", type="circle")
        attr(; x0=0, x1 = annualized(m0.œágrid[end]), y0=0, y1 = annualized(m0.œágrid[end]), type = "line", line_width = 1, line_dash="dash", line_color = "darkred")
    ]
    
    ctœâplot(m0, L, shapes = shape_vec, 
        title = "lim<sub><i>p‚Üí0</i></sub> min<sub><i>œâ</i></sub> ùìõ(<i>p,a,œâ,œá</i>)", 
        slides=slides, dark=dark; kwargs...
    )
end

function Lœâplot(mt::MultiType, L_mat = mt.L_mat; jp=2, slides=true, dark=false, kwargs...)
    L = [minimum(L_mat[:, jœá, jp, ja]) for ja in axes(L_mat, 4), jœá in axes(L_mat, 2)]

    jj = findfirst(L .== minimum(L))
    xmin = annualized(mt.ct.gr[:a][jj[1]])
    ymin = annualized(mt.œágrid[jj[2]])

    shape_vec = [
        attr(; x0=xmin - 0.001, x1=xmin + 0.001, y0=ymin - 0.002, y1=ymin + 0.002, line_color="darkred", fillcolor="darkred", type="circle")
        attr(; x0=0, x1 = annualized(mt.œágrid[end]), y0=0, y1 = annualized(mt.œágrid[end]), type = "line", line_width = 1, line_dash="dash", line_color = "darkred")
    ]
    
    ctœâplot(mt, L, shapes = shape_vec, 
        title = "lim<sub><i>p‚Üí0</i></sub> min<sub><i>œâ</i></sub> ùìõ(<i>p,a,œâ,œá</i>)", 
        slides=slides, dark=dark; kwargs...)
end

ctœâplot(m0::Prequel, y::Array; title = "", slides = true, dark = false, kwargs...) = ctœâplot(m0, y, annualized.(m0.agrid), title = title, slides = slides, dark = dark; kwargs...)

function ctœâplot(mt::Union{MultiType, Prequel}, y::Array, xgrid = annualized.(mt.ct.gr[:a]), ygrid = annualized.(mt.œágrid); title = "", slides = true, dark = false, kwargs...)
    Na, Nœá = length(xgrid), length(ygrid)
    @assert size(y) == (Na, Nœá)

    colpal = ColorSchemes.lapaz
    xt = "Initial inflation (<i>a<sub>0</sub></i>)"
    yt = "Asymptote (œá)"

    data = contour(
        z = y', x = xgrid, y = ygrid,
        colorscale = [[jj, get(colpal, 1-jj, :clamp)] for jj in range(0,1,length=50)]

    )
    layout = Layout(
        xaxis_title = xt, yaxis_title = yt, title = title,
        template = qtemplate(slides=slides, dark=dark);
        kwargs...
    )
    
    plot(data, layout)
end

function ctaplot(mt::MultiType, y::Array; slides = true, dark = false, kwargs...)

    colpal = ColorSchemes.lapaz
    xt = "Decay rate (%)"
    yt = "Initial inflation (<i>a<sub>0</sub></i>)"

    data = contour(
        z = y', x = perc_rate.(mt.œâgrid), y = annualized.(mt.ct.gr[:a]),
        colorscale = [[jj, get(colpal, 1-jj, :clamp)] for jj in range(0,1,length=50)]

    )
    layout = Layout(
        xaxis_title = xt, yaxis_title = yt, 
        template = qtemplate(slides=slides, dark=dark);
        kwargs...
    )
    
    plot(data, layout)
end 


function ctplot(mt::Union{MultiType, Prequel}, y::Array; slides = true, dark = false, kwargs...)
    
	colpal = ColorSchemes.lapaz
    xt = "Decay rate (%)"
    yt = "Asymptote (œá)"

    data = contour(
        z = y', x = perc_rate.(mt.œâgrid), y = annualized.(mt.œágrid),
        colorscale = [[jj, get(colpal, 1-jj, :clamp)] for jj in range(0,1,length=50)]

    )
    layout = Layout(
        xaxis_title = xt, yaxis_title = yt, 
        template = qtemplate(slides=slides, dark=dark);
        kwargs...
    )
    
    plot(data, layout)
end 

function plansp(mt::MultiType; slides = true, dark = false)
    Np = length(mt.ct.gr[:p])

	data = zeros(Np, 3)
    for jp in axes(data, 1)
        
        _, jj = findmin(mt.L_mat[:, :, jp, :])
        
        data[jp, 1] = perc_rate(mt.œâgrid[jj[1]])
        data[jp, 2] = annualized(mt.ct.gr[:a][jj[3]])
        data[jp, 3] = annualized(mt.œágrid[jj[2]])
    end
    
    datanames = ["œâ", "a<sub>0", "œá"]
    yax = ["y2", "y1", "y1"]
    
    cols = [get(ColorSchemes.southwest, jj, :clamp) for jj in [0, 0.5, 1]]
    lines = [
        scatter(;x=mt.ct.gr[:p][2:end], y=data[2:end, jj], line_width = 2.5, yaxis=yax[jj], marker_color=cols[jj], name="<i>"*datanames[jj]*"</i>") for jj in eachindex(datanames)
    ]

	layout = Layout(
        template = qtemplate(dark = dark, slides = slides),
        hovermode = "x",
		yaxis = attr(domain=[0, 0.45], zeroline=false, title="<i>%"),
		yaxis2 = attr(domain=[0.55, 1], zeroline=false, title="<i>%"),
		xaxis = attr(zeroline=false, title="<i>p<sub>0"),
		legend = attr(orientation="h", x=0.05),
		title="Preferred plans",
    )

    plot(lines, layout)
end

function scatscol(z::AbstractMatrix, x::AbstractVector, y::AbstractVector; name = "", sc::ColorScheme=ColorSchemes.batlow, scmax = 0.95, kwargs...)
    @assert size(z) == (length(x), length(y))

    vv = eachindex(y) / length(y)
    m, M = extrema(y)

    col = get(sc, scmax * vv, :clamp)

    jx = round(Int, length(x)/2)
    xs = [x[jx] for _ in axes(z,2)]
    ys = [z[jx, jy] for jy in axes(z,2)]
    cols = range(m,M, length=length(xs))
    colscale = [[(jx-1) / (length(col) - 1), col[jx]] for jx in eachindex(col)]
    colnames = round.(range(m, M, length = 6), digits = 2)

    sc = [scatter(
        mode = "markers", marker_opacity = 0,
        x = xs, y = ys, showlegend=false,
        marker=attr(color=cols, reversescale=false, colorscale=colscale, colorbar=attr(tickvals=range(m, M, length=length(colnames)), title="&nbsp;<i>$name", ticktext=colnames))
    )]

    push!(sc, [
        scatter(x = x, y = z[:, jy], showlegend = false, name = "$name = $(@sprintf("%.3g", y[jy]))", marker_color = col[jy]; kwargs...) for jy in eachindex(y)
    ]...)

    return sc
end

function planspwide(mt::MultiType, dk = nothing; DKcrit = !isnothing(dk), slides = true, dark = false, T = 11, share = true)

    data = zeros(T, length(mt.ct.gr[:p]))

    for jp in axes(data, 2)
        if DKcrit
            _, jj = findmin(dk[:, :, jp, :])
        else
            _, jj = findmin(mt.L_mat[:, :, jp, :])
        end

        a = annualized(mt.ct.gr[:a][jj[3]])
        œá = annualized(mt.œágrid[jj[2]])
        œâ = mt.œâgrid[jj[1]]
        
        for tt in 1:T
            data[tt, jp] = œá + exp(-œâ*(tt-1)) * (a - œá)
        end
    end

    yaxis_title = "%"
    if share
        data .*= 1/annualized(Nash(mt))
        yaxis_title = "Share of Nash inflation"
    end

    layout = Layout(;
        template = qtemplate(;slides, dark), xaxis_title = "<i>Quarters", yaxis_title
    )

    plot(scatscol(data[:,2:end], 0:T-1, mt.ct.gr[:p][2:end], name="p"), layout)
end

function avgplans(mt::MultiType, N = 50; decay=true, CIs=false, slides = true, dark = false)
    data, datanames, zgrid = mimic_z(mt, N, decay=decay, annualize=true)

    cols = [get(ColorSchemes.southwest, jj, :clamp) for jj in (0, 0.5, 1)]
	ls = Vector{PlotlyBase.GenericTrace{Dict{Symbol,Any}}}(undef, 0)

    yax = ["y2", "y1", "y1"]

	for jj in 1:3
		col = cols[jj]
		if CIs
			push!(ls, scatter(;x = zgrid, y = data[:,jj]+data[:,jj+3], yaxis=yax[jj], marker_color=col, mode="lines", opacity = 0.5, showlegend=false, line_width=0.01, hoverinfo="skip"))
			push!(ls, scatter(;x = zgrid, y = data[:,jj]-data[:,jj+3], yaxis=yax[jj], marker_color=col, mode="lines", opacity = 0.5, fill="tonexty", showlegend=false, line_width=0.01, hoverinfo="skip"))
		end
		push!(ls, scatter(;x=zgrid, y=data[:, jj], yaxis=yax[jj], marker_color=col, name="ùîº[<i>"*datanames[jj]*"</i>]"))
	end

	layout = Layout(
        template = qtemplate(slides=slides, dark=dark),
		yaxis = attr(domain=[0, 0.45], title="<i>%"),
		yaxis2 = attr(domain=[0.55, 1], title="<i>%"),
		xaxis = attr(title="<i>z"),
		legend = attr(orientation="h", x=0.05),
		title="Average plans",
		)

	plot(ls, layout)
end

function strategy_Œº(mt::MultiType; save_stats=false, slides = true, dark = false, folder = "")

    œágrid = mt.œágrid
    œâgrid = mt.œâgrid
    agrid = mt.ct.gr[:a]

    marg_aœá = [sum(mt.Œº[:, jœá, ja]) for jœá in axes(mt.Œº, 2), ja in axes(mt.Œº, 3)]

    marg_œâœá = [sum(mt.Œº[jœâ, jœá, :]) for jœâ in axes(mt.Œº, 1), jœá in axes(mt.Œº, 2)]

    c1 = contour(x=annualized.(agrid), y=annualized.(œágrid), z=marg_aœá, colorscale=[[jj, get(ColorSchemes.lapaz, jj, :clamp)] for jj in range(0, 1, length=50)])

    c2 = contour(x=perc_rate.(œâgrid), y=annualized.(œágrid), z=marg_œâœá', colorscale=[[jj, get(ColorSchemes.lapaz, jj, :clamp)] for jj in range(0, 1, length=50)])

    P = sum([sum(mt.Œº[:, jœá, ja]) for jœá in 1:length(œágrid), ja in 1:length(agrid) if agrid[ja] > œágrid[jœá]])
    print("P(a_0 > œá) = $(@sprintf("%0.3g",100P))%\n")
    save_stats && write(folder * "pa_chi.txt", "$(@sprintf("%0.3g",100P))\\%.")

    P = sum([sum(mt.Œº[:, jœá, ja]) for jœá in 1:length(œágrid), ja in 1:length(agrid) if agrid[ja] > 5œágrid[jœá]])
    print("P(a_0 > 5œá) = $(@sprintf("%0.3g",100P))%\n")
    save_stats && write(folder * "pa_chi5.txt", "$(@sprintf("%0.3g",100P))\\%.")

    P = sum([sum(mt.Œº[:, jœá, ja]) for jœá in 1:length(œágrid), ja in 1:length(agrid) if œágrid[jœá] == 0])
    print("P(a_0 > 0) = $(@sprintf("%0.3g",100P))%\n")
    save_stats && write(folder * "pa_chi0.txt", "$(@sprintf("%0.3g",100P))\\%.")

    P = sum([sum(mt.Œº[jœâ, jœá, ja]) for jœá in 1:length(œágrid), ja in 1:length(agrid), jœâ in 1:length(œâgrid) if perc_rate(œâgrid[jœâ]) <= 10])
    print("P(œâ ‚â§ 10%) = $(@sprintf("%0.3g",100P))%\n")
    save_stats && write(folder * "pa_omega0.txt", "$(@sprintf("%0.3g",100P))\\%.")

    l1 = Layout(
        template = qtemplate(slides=slides, dark=dark),
        title="lim<sub>z‚Üí0</sub>‚à´<i>Œº<sub>z</sub></i> (<i>œâ, œá, a<sub>0</sub></i>) d<i>œâ</i>",
        font_size=16,
        xaxis=attr(title="Initial inflation (<i>a<sub>0</sub></i>)"),
        yaxis=attr(title="Asymptote (<i>œá</i>)"),
        shapes = [attr(x0=0, x1 = annualized(œágrid[end]), y0=0, y1=annualized(œágrid[end]), type = "line", line_color="darkred", line_dash="dash", line_width = 1)]
    )
    l2 = Layout(
        template = qtemplate(slides=slides, dark=dark),
        title="lim<sub>z‚Üí0</sub>‚à´<i>Œº<sub>z</sub></i> (<i>œâ, œá, a<sub>0</sub></i>) d<i>a<sub>0</sub></i>",
        xaxis=attr(title="Decay rate (<i>%</i>)"),
        yaxis=attr(title=""),
    )

    p1 = plot(c1, l1)
    p2 = plot(c2, l2)

    return p1, p2
end

function get_Kambe(mt::MultiType; jp = 2)
	minL, jj = findmin(mt.L_mat[:, :, jp, :])
	œâK = mt.œâgrid[jj[1]]
	œáK = mt.œágrid[jj[2]]
	aK = mt.ct.gr[:a][jj[3]]

    return œâK, œáK, aK
end

function prep_plot_planner(mt::MultiType; k = 10)
	ct = mt.ct
	rp = Ramsey(ct)

	vfi!(rp, verbose = false)
	œÄR, Œ∏R = simul_plan(rp)

	# tvec = 1:length(œÄR)
    tvec = (0:k) .+ 1

	mean_œâ, mean_a, mean_œá, sd_œâ, sd_a, sd_œá = find_plan_Œº(mt; annualize=false, decay=false)

	œÄC = (mean_a - mean_œá) * exp.(-mean_œâ * (tvec.-1)) .+ mean_œá

    œâK, œáK, aK = get_Kambe(mt)

	œÄK = (aK - œáK) * exp.(-œâK * (tvec.-1)) .+ œáK

    return tvec, œÄR, œÄC, œÄK
end

function get_Kambe(m0::Prequel, jA; jp = 2)
	minL, jj = findmin(m0.L[:, :, :, jp, jA])
	œâK = m0.œâgrid[jj[1]]
	œáK = m0.œágrid[jj[2]]
	aK = m0.agrid[jj[3]]

    return œâK, œáK, aK
end

function prep_plot_prequel(m0::Prequel; k = 10, jA = 1)
    tvec = (0:k) .+ 1
    
    œâK, œáK, aK = get_Kambe(m0, jA)
	œÄK = (aK - œáK) * exp.(-œâK * (tvec.-1)) .+ œáK

    œÄK = vcat([m0.Agrid[jA]], œÄK)
    return 0:11, œÄK
end

function comp_plot_planner(mt::MultiType; k = 10, slides::Bool=true, dark = false, Kambe = true, Average = true, share = true, kwargs...)

    yaxis_title = "%"

    tvec, œÄR, œÄC, œÄK = prep_plot_planner(mt; k)



    if share
        yaxis_title = "Share of Nash inflation"
        œÄN = Nash(mt)
        œÄR *= 1/œÄN
        œÄC *= 1/œÄN
        œÄK *= 1/œÄN
    else
        œÄR = annualized.(œÄR)
        œÄC = annualized.(œÄC)
        œÄK = annualized.(œÄK)
    end

    layout = Layout(;
        title="Plans", xaxis_title="<i>Quarters", yaxis_title, legend=attr(orientation="h", x=0.05), template = qtemplate(slides = slides, dark = dark),
        kwargs...
    )
    data = [
        scatter(x=tvec.-1, y=œÄR[tvec], marker_color=get(ColorSchemes.southwest, 0.01, :clamp), name="<i>Ramsey", showlegend=true)
        ]
    if Kambe
        push!(data, scatter(x=tvec.-1, y=œÄK[tvec], marker_color=get(ColorSchemes.southwest, 0.5, :clamp), name="<i>Optimal eq'm"))
    end
    if Average
        push!(data, scatter(x=tvec.-1, y=œÄC[tvec], marker_color=get(ColorSchemes.southwest, 0.99, :clamp), name="<i>Average eq'm"))
    end

    plot(data, layout)
end

function show_Œº(mt::MultiType; slides = true, dark = false)
	pgrid, agrid = mt.ct.gr[:p], mt.ct.gr[:a]
	œâgrid, œágrid = mt.œâgrid, mt.œágrid

    œÄN = Nash(mt.ct)
	tvec = 1:11

    L = mt.L_mat[:, :, 2, :]
    Œº = (-L .+ maximum(L)) / (maximum(L) - minimum(L))

    marker = attr(color = get(ColorSchemes.oslo, 0.4, :clamp))

    sc = [
        scatter(x=tvec .- 1, y=100*((av - œáv) * exp.(-œâv * tvec .- 1) .+ œáv) / œÄN; showlegend=false, marker = get(ColorSchemes.oslo, 0.8 * (1-Œº[jœâ, jœá, ja]), :clamp), hoverinfo="skip", line_width = 0.1, opacity=Œº[jœâ, jœá, ja]^13, mode="lines") for (ja, av) in enumerate(agrid), (jœâ, œâv) in enumerate(œâgrid), (jœá, œáv) in enumerate(œágrid)
    ] |> vec

    layout = Layout(template = qtemplate(; slides, dark),
        xaxis_title = "Quarters", yaxis_title = "Inflation (% of Nash)",
    )

    plot(sc, layout)
end

function comp_plot_planner(m0::Prequel, mt::MultiType; jA = 1, slides=true, dark=false)
    tvec, œÄR, œÄC, œÄK = prep_plot_planner(mt)

    tvec2, œÄK0 = prep_plot_prequel(m0; jA)

    layout = Layout(
        title="Plans", yaxis_title="%", xaxis_title="<i>Quarters",
        legend=attr(orientation="h", x=0.05),
        template = qtemplate(slides = slides, dark = dark)
    )
    data = [
        scatter(x=tvec.-1, y=annualized.(œÄR)[tvec], marker_color=get(ColorSchemes.southwest, 0.01, :clamp), name="<i>Ramsey")
        scatter(x=tvec.-1, y=annualized.(œÄC)[tvec], marker_color=get(ColorSchemes.southwest, 0.99, :clamp), name="<i>Average eq'm")
        scatter(x=tvec.-1, y=annualized.(œÄK)[tvec], marker_color=get(ColorSchemes.southwest, 0.5, :clamp), name="<i>Kambe eq'm")
        scatter(x=tvec2.-1, y=annualized.(œÄK0), name ="<i>Kambe eq'm with initial period", line_dash="dash")
    ]

    plot(data, layout)
end

function Lœâplot(mt::Multiœà; jp = 2, slides = true, dark = false)

    L = [minimum(mt.L[:, :, jœà, jp, ja]) for jœà in axes(mt.L,3), ja in axes(mt.L, 5)]

    layout = Layout(
        template = qtemplate(slides=slides, dark=dark),
        xaxis_title = "Initial inflation (<i>a<sub>0</sub></i>)",
        yaxis_title = "œà",
    )
    colpal = ColorSchemes.lapaz
    data = contour(
        z = L, y = mt.œàgrid, x = annualized.(mt.ct.gr[:a]),
        colorscale = [[jj, get(colpal, 1-jj, :clamp)] for jj in range(0,1,length=50)],
    )

    plot(data, layout)
end

function twolines(mt::Multiœà; show="L", jp = 2, slides = true, dark = false)
    cols = [get(ColorSchemes.southwest, x, :clamp) for x in (0.99, 0.5)]
    # L_reopt = [minimum(mt.L[:,:,jœà, jp,:]) for jœà in eachindex(mt.œàgrid)]
    L_reopt = zeros(length(mt.œàgrid))
    C_reopt = similar(L_reopt)
    for jœà in eachindex(mt.œàgrid)
        L, jj = findmin(mt.L[:,:,jœà, jp, :])
        L_reopt[jœà] = L
        C_reopt[jœà] = mt.C[jj[1], jj[2], jœà, jp, jj[3]]
    end

    _, jj = findmin(mt.L[:,:,1,jp,:])
    jœâ = jj[1]
    jœá = jj[2]
    ja = jj[3]

    L_og = mt.L[jœâ, jœá, :, jp, ja]
    C_og = mt.C[jœâ, jœá, :, jp, ja]

    data = [
        scatter(x=mt.œàgrid, y = L_reopt, marker_color=cols[1], name = "<b>a</b>*(œà)")
        scatter(x=mt.œàgrid, y = L_og, marker_color=cols[2], name = "<b>a</b>*")
    ]
    if show == "C"
        data = [
            scatter(x=mt.œàgrid, y = C_reopt, marker_color=cols[1], name = "<b>a</b>*(œà)")
            scatter(x=mt.œàgrid, y = C_og, marker_color=cols[2], name = "<b>a</b>*")
        ]
    end

    layout = Layout(
        template = qtemplate(slides=slides, dark=dark),
        xaxis_title = "<i>œà"
    )

    plot(data, layout)
end

function implied_plan(mt::Multiœà; jp = 2, slides = true, dark = false)

    œàvec = mt.œàgrid

    œâvec = similar(œàvec)
    œávec = similar(œàvec)
    avec = similar(œàvec)

    for jœà in eachindex(œàvec)
        _, jj = findmin(mt.L[:,:,jœà,jp,:])
        œâvec[jœà] = mt.œâgrid[jj[1]]
        œávec[jœà] = mt.œágrid[jj[2]]
        avec[jœà] = mt.ct.gr[:a][jj[3]]
    end

    œâvec = perc_rate.(œâvec)
    œávec = annualized.(œávec)
    avec = annualized.(avec)

    cols = [get(ColorSchemes.southwest, jj, :clamp) for jj in [0, 0.5, 1]]

    lines = [
        scatter(x = œàvec, y = œâvec, line_width = 2.5, yaxis = "y2", marker_color = cols[1], name = "<i>œâ*(œà)")
        scatter(x = œàvec, y = avec, line_width = 2.5, yaxis = "y1", marker_color = cols[2], name = "<i>a<sub>0</sub>*(œà)")
        scatter(x = œàvec, y = œávec, line_width = 2.5, yaxis = "y1", marker_color = cols[3], name = "<i>œá*(œà)")
    ]

	layout = Layout(
        template = qtemplate(;slides, dark),
        hovermode = "x",
		yaxis = attr(domain=[0, 0.45], zeroline=false, title="<i>%"),
		yaxis2 = attr(domain=[0.55, 1], zeroline=false, title="<i>%"),
		xaxis = attr(zeroline=false, title="<i>œà"),
		legend = attr(orientation="h", x=0.05),
		title="Preferred plans",
    )

    plot(lines, layout)
end

function implied_plan_wide(mt::Multiœà, dk = nothing; DKcrit=!isnothing(dk), jp = 2, slides = true, dark = false, share = true, T = 11)

    œàvec = mt.œàgrid

    data = zeros(T, length(œàvec))
    for jœà in axes(data, 2)
        if DKcrit
            _, jj = findmin(dk[:, :, jœà, jp, :])
        else
            _, jj = findmin(mt.L[:, :, jœà, jp, :])
        end

        a = annualized(mt.ct.gr[:a][jj[3]])
        œá = annualized(mt.œágrid[jj[2]])
        œâ = mt.œâgrid[jj[1]]

        for tt in 1:T
            data[tt, jœà] = œá + exp(-œâ * (tt - 1)) * (a - œá)
        end
    end

    yaxis_title = "%"
    if share
        data .*= 1 / annualized(Nash(mt))
        yaxis_title = "Share of Nash inflation"
    end

    vv = [jœà / length(œàvec) for jœà in eachindex(œàvec)]
    min_z, max_z = extrema(œàvec)
    col = get(ColorSchemes.batlow, 0.85 * vv, :clamp)

    jT = round(Int, T / 2)
    xs = [jT for _ in axes(data, 2)]
    ys = [data[jT, ja] for ja in axes(data, 2)]
    cols = range(0, 1, length=length(xs))
    colscale = [[(jT - 1) / (length(col) - 1), col[jT]] for jT in eachindex(col)]
    colnames = round.(range(min_z, max_z, length=6), digits=2)


    lines = [
        scatter()
        scatter(mode="markers", marker_opacity=0,
            x=xs, y=ys, showlegend=false,
            marker=attr(color=cols, reversescale=false, colorscale=colscale, colorbar=attr(tickvals=range(0, 1, length=length(colnames)), title="&nbsp;<i>œà", ticktext=colnames))
        )
        [scatter(x=(1:T) .- 1, y=data[:, jœà], marker_color=col[jœà], showlegend=false) for jœà in axes(data, 2) if jœà > 1]
    ]
    layout = Layout(;
        template=qtemplate(; slides, dark), xaxis_title="<i>Quarters", yaxis_title, yaxis_range = [-0.01, maximum(data)*1.05]
    )

    # lines = scatscol(data[:,2:end], 0:T-1, œàvec[2:end], name=string(k))

    plot(lines, layout)
end




function allplans(mt::Multiœà; jp = 2, T = 11, slides = true, dark = false)

    œàvec = mt.œàgrid

    œâvec = similar(œàvec)
    œávec = similar(œàvec)
    avec = similar(œàvec)

    cvec = zeros(1:T, length(œàvec))

    for jœà in eachindex(œàvec)
        _, jj = findmin(mt.L[:,:,jœà,jp,:])
        œâvec[jœà] = mt.œâgrid[jj[1]]
        œávec[jœà] = mt.œágrid[jj[2]]
        avec[jœà] = mt.ct.gr[:a][jj[3]]

        a = annualized(avec[jœà])
        œá = annualized(œávec[jœà])
        Œ© = exp(-œâvec[jœà])
        
        for tt in 1:T
            cvec[tt, jœà] = œá + Œ©^(tt-1) * (a - œá)
        end
    end

    lines = [scatter(x = 0:T-1, y = cvec[:, jœà], name = "œà = $(round(œàv, sigdigits=2))") for (jœà, œàv) in enumerate(œàvec)]

    layout = Layout(
        template = qtemplate(;slides, dark)
    )

    plot(lines, layout)
end

function reformat_x(xvec, k::Symbol)
    if k == :œÉ
        xvec = xvec * 400
    elseif k == :Œ≤
        xvec = xvec.^(-4)
    elseif k == :Œ∫
    else
        throw(error("Wrong parameter name"))
    end
    xvec
end

function plot_compstats(k::Symbol, T = 11; share = false, slides = true, dark = false, showLmat = false)

    s = sk(k)

    œâvec, œávec, avec, xvec, Lmat, pvec = load("Output/JET/compstats_$s.jld2", "œâvec", "œávec", "avec", "$(s)vec", "Lmat", "pvec")

    K = length(xvec)
    plans = zeros(T, K)
    for jk in eachindex(xvec)

        a = annualized(avec[jk])
        œá = annualized(œávec[jk])
        Œ© = exp(-œâvec[jk])
        
        for tt in 1:T
            plans[tt, jk] = œá + Œ©^(tt-1) * (a - œá)
        end
    end

    xvec = reformat_x(xvec, k)

    yaxis_title = "%"
    if share
        plans .*= 1 / annualized(Nash(mt))
        yaxis_title = "Share of Nash inflation"
    end

    if showLmat
        return plot(
            contour(z = Lmat, x = pvec, y = xvec), 
            Layout(;template = qtemplate(;slides, dark), xaxis_title = "<i>p", yaxis_title = "<i>$(string(k))")
        )
    end

    plot(scatscol(plans, 0:T-1, xvec, name =string(k)), Layout(;
            template=qtemplate(; slides, dark), xaxis_title="<i>Quarters", yaxis_title, yaxis_range=[-0.01, maximum(plans) * 1.05]
        )
    )
end


findflex(y::Array{T, 2}; jp) where T = findmin(y[jp, :])[2]
findflex(y::Array{T, 3}; jp) where T = findmin(y[jp, :, :])[2]
findflex(y::Array{T, 4}; jp) where T = findmin(y[jp, :, :, :])[2]
findflex(y::Array{T, 5}; jp) where T = findmin(y[jp, :, :, :, :])[2]
findflex(y::Array{T, 6}; jp) where T = findmin(y[jp, :, :, :, :, :])[2]

function bestflex(z::Zero, mt=nothing; slides = true, dark = false, share = true)
    T = periods(z)

    a = zeros(T+4, T+4) * NaN

    y = z.L
    for (jt, tt) in enumerate(T:-1:2)

        jv = findflex(y, jp = 2)
        a_inv = annualized.(z.gr[:a][i] for i in Tuple(jv))

        a[periods(z)-tt+1:periods(z), jt] = a_inv[end:-1:1]
        
        if periods(z) < size(a,1)
            a[periods(z)+1:end, jt] .= a[periods(z), jt]
        end

        y = same_last_two(y)
    end

    yaxis_title = "%"
    if share
        yaxis_title = "Share of Nash inflation"
        a .*= 1/annualized(Nash(z))
    end

    sc = [
        [scatter(x=T-1:length(a), y=a[T+1:end, jj], name="<i>K</i> = $(periods(z)-jj+1)", marker_color=Owls(jj), legendgroup = jj, showlegend = false, line_dash="dot") for jj in 1:T-1]
        [scatter(x=axes(a, 1) .- 1, y=a[1:T, jj], name="<i>K</i> = $(periods(z)-jj)", marker_color=Owls(jj), legendgroup=jj) for jj in 1:T-1]
    ]
    My = maximum(a[.!(isnan.(a))])*1.05

    plans = zeros(T+3)
    if !isnothing(mt)
        _, jj = findmin(mt.L_mat[:, :, 2, :])
        a = annualized(mt.ct.gr[:a][jj[3]])
        œá = annualized(mt.œágrid[jj[2]])
        œâ = mt.œâgrid[jj[1]]
        
        for tt in eachindex(plans)
            plans[tt] = œá + exp(-œâ*(tt-1)) * (a - œá)
        end
        if share
            plans .*= 1/annualized(Nash(mt))
        end

        push!(sc,
            scatter(x = eachindex(plans).-1, y = plans, line_dash = "dash", marker_color = Owls(T), name = "Opt. announcement")
        )
    end
    Mp = maximum(plans * 1.05)

    My = max(My, Mp)

    plot(sc, Layout(; template=qtemplate(; slides, dark), xaxis_title="<i>Quarters", yaxis_title, yaxis_range = [-0.05, My]))
end
